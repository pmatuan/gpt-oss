srun: job 82118 queued and waiting for resources
srun: job 82118 has been allocated resources
vocab_size: 201088
hidden_dim: 2880
n_experts: 32
experts_per_token: 4
intermediate_dim: 2880
n_layers: 24
head_dim: 64
n_attn_heads: 64
n_kv_heads: 8
max_seq_len: 2048
init context len: 4096
rope theta: 150000.000000
rope_scaling_factor: 32.000000
sliding window: 128
swiglu_limit: 7.000000
requests size = 235110400 B
Num requests: 896
Found 1 HIP devices, initializing multi-GPU setup...
Not using expert parallelism (n_experts=32, n_devices=1)
Initializing device 0 for batch size 896...
[DEVICE] 0 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 0 [HIP] after activations: HBM free 63.00 GiB / total 63.98 GiB (used 0.98 GiB)
[DEVICE] 0 [HIP] after small BF16 weights: HBM free 62.99 GiB / total 63.98 GiB (used 0.99 GiB)
[DEVICE] 0 [HIP] after expert biases: HBM free 62.97 GiB / total 63.98 GiB (used 1.01 GiB)
[DEVICE] 0 [HIP] after large BF16 weights: HBM free 24.03 GiB / total 63.98 GiB (used 39.95 GiB)
[DEVICE] 0 allocated KV cache full 1024 tokens
[DEVICE] 0 [HIP] after KV cache allocation (model fully loaded): HBM free 0.41 GiB / total 63.98 GiB (used 63.58 GiB)
Multi-GPU initialization complete!

warm up elapsed time(s): 37.928000
Processing 896 requests across 1 GPUs...
Multi-GPU inference completed. Total tokens generated: 891656

elapsed time(s): 233.936000, achieved throughput TPS (tok/s): 3811.538198

finish elapsed time(s): 0.001000

┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                  PROFILER SUMMARY                                    │
├──────────────────────────────────────────────────────────────────────────────────────┤
│ Function/Kernel Name                          │   Total (ms) │    Calls │   Avg (ms) │
├──────────────────────────────────────────────────────────────────────────────────────┤
│ CPU:inference                                 │   233936.505 │        1 │ 233936.505 │
│ CPU:gpu_forward_device_batch                  │   233872.390 │     1023 │    228.614 │
│ GPU:mlp1_fused_gemm                           │    82021.567 │    24552 │      3.341 │
│ GPU:flash_decoding_odd                        │    48854.897 │    12276 │      3.980 │
│ GPU:mlp2_noatomic_gemm                        │    40936.103 │    24552 │      1.667 │
│ GPU:flash_decoding_even                       │    13984.524 │    12276 │      1.139 │
│ GPU:matmul_logits_kernel                      │    13137.078 │     1023 │     12.842 │
│ GPU:matmul_bias_att_kernel                    │     9748.084 │    24552 │      0.397 │
│ GPU:matmul_bias_qkv_kernel                    │     8624.498 │    24552 │      0.351 │
│ GPU:matmul_router_kernel                      │     2818.081 │    24552 │      0.115 │
│ GPU:residual_add_batch_kernel                 │     1630.648 │    49104 │      0.033 │
│ GPU:rmsnorm_batch_kernel                      │     1574.172 │    50127 │      0.031 │
│ GPU:reduce_mlp2_slots                         │     1493.979 │    24552 │      0.061 │
│ GPU:fused_split_rope_scatter_qkv_batch_kernel │      928.850 │    24552 │      0.038 │
│ GPU:fused_topk_softmax_batch_kernel           │      899.220 │    24552 │      0.037 │
│ GPU:argmax_batch_kernel                       │      663.787 │     1023 │      0.649 │
│ GPU:zero_mlp2_partial                         │      658.050 │    24552 │      0.027 │
│ GPU:expert_assignment_building                │      439.614 │    24552 │      0.018 │
│ GPU:expert_counting                           │      414.287 │    24552 │      0.017 │
│ GPU:exclusive_scan_small_kernel               │      257.841 │    24552 │      0.011 │
│ GPU:copy_embedding_bf16_batch_kernel          │       35.833 │     1023 │      0.035 │
└──────────────────────────────────────────────────────────────────────────────────────┘

