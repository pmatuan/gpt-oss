srun: job 80113 queued and waiting for resources
srun: job 80113 has been allocated resources
vocab_size: 201088
hidden_dim: 2880
n_experts: 128
experts_per_token: 4
intermediate_dim: 2880
n_layers: 36
head_dim: 64
n_attn_heads: 64
n_kv_heads: 8
max_seq_len: 2048
init context len: 4096
rope theta: 150000.000000
rope_scaling_factor: 32.000000
sliding window: 128
swiglu_limit: 7.000000
requests size = 1612185600 B
Num requests: 6144
Found 8 HIP devices, initializing multi-GPU setup...
Using expert parallelism with 8 devices and 128 experts
Initializing device 0 for batch size 768...
Initializing device 3 for batch size 768...
[DEVICE] 0 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 3 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
Initializing device 7 for batch size 768...
Initializing device 1 for batch size 768...
Initializing device 4 for batch size 768...
Initializing device 6 for batch size 768...
Initializing device 2 for batch size 768...
[DEVICE] 7 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 4 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 6 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 1 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 2 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
Initializing device 5 for batch size 768...
[DEVICE] 5 [HIP] before allocations: HBM free 63.90 GiB / total 63.98 GiB (used 0.09 GiB)
[DEVICE] 1 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 1 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 0 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 0 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 4 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 4 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 7 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 7 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 2 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 2 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 3 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 3 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 5 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 6 [HIP] after activations: HBM free 63.12 GiB / total 63.98 GiB (used 0.86 GiB)
[DEVICE] 6 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 5 [HIP] after small BF16 weights: HBM free 63.09 GiB / total 63.98 GiB (used 0.89 GiB)
[DEVICE] 1 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 0 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 7 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 2 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 6 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 3 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 4 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 5 [HIP] after expert biases: HBM free 63.02 GiB / total 63.98 GiB (used 0.97 GiB)
[DEVICE] 2 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 3 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 2 allocated KV cache full 1024 tokens
[DEVICE] 2 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 4 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 3 allocated KV cache full 1024 tokens
[DEVICE] 3 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 4 allocated KV cache full 1024 tokens
[DEVICE] 4 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 7 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 1 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 5 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 0 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 6 [HIP] after large BF16 weights: HBM free 32.38 GiB / total 63.98 GiB (used 31.61 GiB)
[DEVICE] 7 allocated KV cache full 1024 tokens
[DEVICE] 7 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 1 allocated KV cache full 1024 tokens
[DEVICE] 1 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 5 allocated KV cache full 1024 tokens
[DEVICE] 6 allocated KV cache full 1024 tokens
[DEVICE] 0 allocated KV cache full 1024 tokens
[DEVICE] 5 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 0 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
[DEVICE] 6 [HIP] after KV cache allocation (model fully loaded): HBM free 2.00 GiB / total 63.98 GiB (used 61.98 GiB)
Multi-GPU initialization complete!

warm up elapsed time(s): 79.774000
Processing 6144 requests across 8 GPUs...
Multi-GPU inference completed. Total tokens generated: 6060259

elapsed time(s): 772.313000, achieved throughput TPS (tok/s): 7846.894977

finish elapsed time(s): 0.122000
